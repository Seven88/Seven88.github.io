---
title: 以太坊交易应用处理简析
date: 2017-09-26 16:59:23
tags: [以太坊, geth]
---

### What

随着区块链技术的高速发展，各种数字货币的交易几乎不需要人工干预，由 web 应用系统自动处理的情况已经十分常见。比如数字货币 ICO、交易所等场景。在这些 web 交易系统中，必须有一套安全可靠的处理机制来保证交易顺利完成。本文简单介绍一下 web 应用怎样处理以太坊交易及其中遇到的一些坑。

### Why

发起一笔以太坊交易是很容易的，但并不是每一笔交易都能成功。在实际应用中，业务层发起一笔交易，通常期望最终交易结果是成功的。那么我们要做的，就是建立一套可靠的机制来处理交易过程中可能遇到的各种问题，最终使得交易成功。

### How

首先，我们来看一下处理以太网交易的大致流程：

1. 本地节点发起交易；
2. 交易通过P2P网络广播出去；
3. 等待矿工将交易打包到区块链；
4. 等待足够多的确认（通常12个确认即认为是安全的交易）；

看似简单的流程，实际应用过程中却可能会碰上各种坑。下面结合我们在生成环境中的经验，逐一说明遇到的各种问题及解决方案。

#### 一、发起交易错误，transaction underpriced

这个错误出现在上面的步骤1，也就是说该交易在本地就失败了。通过错误描述和底层代码分析，我们知道了该错误导致的原因：

*当交易池超过容量时，如果该交易的交易费用低于当前交易列表的最小值，则拒绝该笔交易；如果比其它交易高，则从已有的交易中移除一笔交易费用最低的交易，为当前这笔交易留出空间。*

显然，我们希望所有交易都能成功发出，所以该问题的解决方案就是在一段时间后重新发起这笔交易。通过该问题也说明，本地发送交易不应过于频繁，否则成功率将很难保证。

#### 二、nonce 参数问题

nonce 参数用于防双花攻击。每一个账户从同一个节点发起交易时，这个 nonce 值从0开始计数，发送一笔 nonce 对应加1。当前面的nonce 处理完成之后才会处理后面的 nonce。**注意这里的前提条件是相同的地址在相同的节点发送交易。**

以下是 nonce 使用的几条规则：

- 当 nonce 太小（小于之前已经有交易使用的nonce值），交易会被直接拒绝；
- 当 nonce 太大，交易会一直处于队列之中；
- 当发送一个比较大的 nonce 值，然后补齐开始 nonce 到那个值之间的 nonce，那么交易依旧可以被执行；
- 当交易处于 queue 中时停止 geth 客户端，那么交易 queue 中的交易会被清除掉；

在发起交易阶段可能会遇到`nonce too low`的错误代码，这种情况重新生成交易发送即可；此外还有可能本地交易已成功发起，获取到了交易 hash，但实际上该笔交易的 nonce 是错误的，那么该交易是不会被任何矿工打包确认的。

综上，如果在发起交易阶段因为 nonce 问题失败，则可以安全的重新发起交易；成功发起的交易，可以先检查其 nonce 是否有效，如果无效，则该交易需重新发起，有效则可以继续后面的等待确认流程。

#### 三、合约执行错误

在执行以太网合约交易时，会出现交易本身已经成功写入区块链上，但实际想要执行的合约出错的情况。如图：

![Error encountered during contract execution](https://img.shandianim.com/cms/img/2c0ebe1412548452de713e56e0ba09be.png)

此时系统需要根据业务需求，判断是否需要重新发起交易。

#### 四、gasPrice

以太坊的交易费用 = gasUsed * gasPrice。gasUsed由交易需要执行的计算量决定，gasPrice 可以自己设置也可以使用默认值。geth会默认设置一个大多数矿工可以接受的 gasPrice（这个值不是一直不变的，具体怎么变动有待研究）。

gasPrice 不仅决定交易是否能成功发起，也影响着系统的工作效率，过高则浪费以太币，过低则交易很难被矿工打包。所以系统能够设置 gasPrice 是非常有必要的。

#### 五、交易失败处理

交易失败处理需要注意的是一定要确保该交易是失败的，否则可能造成巨大损失。比如系统需要转出给用户一笔大额 ETH，由于错误的把已成功的交易判断为失败，然后又转了一笔，这样最后给用户转了预期两倍的 ETH，甚至有可能转更多次。这种损失几乎是不可挽回的，必须百分百杜绝。

常见的交易失败情况之一是在交易发起时，此时交易在本地就失败了，可以比较安全的重新发起交易。

另一种常见情况是在等待交易确认时，即本地交易已成功返回交易 hash，然后用该 hash 等待矿工确认。但有可能等待很久都没有等到确认信息，则很可能该交易失败了。这种情况下，则需要至少两个步骤确认：

1. 通过本地节点确认交易失败（比如 nonce 值错误）；
2. 通过第三方 API 确认交易失败；

通过这两步确认后，才可以重新发起交易。

